<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OBJ Viewer – Closed Delaunay in S³</title>

  <!-- Load MathJax for LaTeX rendering in the header -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>

  <!-- Font for the header -->
  <link href="https://fonts.googleapis.com/css2?family=Rounded+Mplus+1c&display=swap" rel="stylesheet">

  <!-- External stylesheet -->
  <link rel="stylesheet" href="../style.css" />

  <!-- Import map for ES Modules (Three.js) -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js"
    }
  }
  </script>
</head>

<body>
  <!-- Page title -->
  <header>Closed Delaunay surface in \(\mathbb{S}^3\)</header>

  <!-- Status messages -->
  <div id="loading">Now loading OBJ model…</div>
  <div id="error" style="display:none;">Sorry, failed to load OBJ file.</div>

  <!-- UI controls -->
  <button id="toggleAxes">Toggle Axes</button>
  <button id="toggleEdges" class="controlBtn">Toggle Edges</button>

  <label id="opacityLabel">
    Opacity: <span id="opacityValue">1.00</span>
  </label>
  <input type="range" id="opacitySlider" min="0" max="1" step="0.01" value="1" />

  <!-- Main script -->
  <script type="module">
    // 1. Import Three.js and helpers
    import * as THREE from 'three';
    import { ArcballControls } from 'https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/controls/ArcballControls.js';
    import { OBJLoader } from 'https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/loaders/OBJLoader.js';
    import { MTLLoader } from 'https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/loaders/MTLLoader.js';

    // 2. Basic scene setup
    const scene = new THREE.Scene();

    const camera = new THREE.PerspectiveCamera(
      60, window.innerWidth / window.innerHeight, 0.1, 1000
    );
    camera.position.set(0, 1, 5);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // 3. Controls (no panning)
    const controls = new ArcballControls(camera, renderer.domElement, scene);
    controls.enableAnimations = true;
    controls.setGizmosVisible(false);
    controls.enablePan = false;

    // 4. Lighting
    scene.add(new THREE.AmbientLight(0xffffff, 1.4));
    const dirLight = new THREE.DirectionalLight(0xffffff, 3.0);
    scene.add(dirLight);

    // 5. Axes helper (hidden by default)
    const axesHelper = new THREE.AxesHelper(1.5);
    axesHelper.visible = false;
    scene.add(axesHelper);

    // Toggle axes + gizmo
    document.getElementById('toggleAxes').addEventListener('click', () => {
      const visible = !axesHelper.visible;
      axesHelper.visible = visible;
      controls.setGizmosVisible(visible);
    });

    // 6. UI elements
    const slider = document.getElementById('opacitySlider');
    const valueLabel = document.getElementById('opacityValue');
    const toggleEdgesBtn = document.getElementById('toggleEdges');

    let currentModel = null;
    let edgesVisible = false; // ✅ default: edges OFF
    const edgeObjects = [];

    // 7. Opacity slider → update all mesh materials
    slider.addEventListener('input', () => {
      const v = parseFloat(slider.value);
      valueLabel.textContent = v.toFixed(2);
      if (currentModel) {
        currentModel.traverse(o => {
          if (o.isMesh) {
            o.material.opacity = v;
            o.material.transparent = v < 1.0;
          }
        });
      }
    });

    // 8. Toggle edge visibility
    toggleEdgesBtn.addEventListener('click', () => {
      edgesVisible = !edgesVisible;
      edgeObjects.forEach(edge => edge.visible = edgesVisible);
    });

    // 9. Load MTL → then OBJ
    new MTLLoader().load('./discrete2.mtl', mats => {
      mats.preload();

      new OBJLoader().setMaterials(mats).load('./discrete2.obj',
        obj => {
          obj.traverse(child => {
            if (!child.isMesh) return;

            // ✅ Material settings
            child.material.transparent = true;
            child.material.opacity = parseFloat(slider.value);
            child.material.side = THREE.DoubleSide;
            child.renderOrder = 1; // Helps with transparency ordering

            // ✅ Create edges (initially hidden)
            const edgeGeom = new THREE.EdgesGeometry(child.geometry);
            const edgeMat = new THREE.LineBasicMaterial({ color: 0xffffff });
            const edges = new THREE.LineSegments(edgeGeom, edgeMat);
            edges.visible = false;
            child.add(edges);
            edgeObjects.push(edges);
          });

          obj.scale.set(1, 1, 1);
          scene.add(obj);
          currentModel = obj;
          document.getElementById('loading').style.display = 'none';
        },
        undefined,
        () => {
          document.getElementById('loading').style.display = 'none';
          document.getElementById('error').style.display = 'block';
        }
      );
    });

    // 10. Render loop
    const animate = () => {
      requestAnimationFrame(animate);
      dirLight.position.copy(camera.position);
      dirLight.target.position.set(0, 0, 0);
      dirLight.target.updateMatrixWorld();
      controls.update();
      renderer.render(scene, camera);
    };
    animate();

    // 11. Responsive resize
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
